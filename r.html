<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>R</title>

<script src="site_libs/header-attrs-2.14/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />
<link rel="shortcut icon" href="images/duck_guidance.png"/>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>






<link rel="stylesheet" href="images/acalat_theme.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Statistics Production Guidance</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Learning and development
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="l+d.html">General resources</a>
    </li>
    <li>
      <a href="sql.html">SQL</a>
    </li>
    <li>
      <a href="r.html">R</a>
    </li>
    <li>
      <a href="git.html">Git</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Creating statistics
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="rap.html">Processes and RAP</a>
    </li>
    <li>
      <a href="ud.html">Open data standards</a>
    </li>
    <li>
      <a href="cd.html">Writing and visualising</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Publishing statistics
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="pub.html">How to publish</a>
    </li>
    <li>
      <a href="ees.html">Using EES</a>
    </li>
    <li>
      <a href="examples.html">EES examples</a>
    </li>
    <li>
      <a href="dashboards.html">Dashboards</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Understanding users
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="user_eng.html">User engagement</a>
    </li>
    <li>
      <a href="user_an.html">EES analytics</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="mailto:statistics.development@education.gov.uk">
    <span class="fa fa-envelope"></span>
     
    
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">R</h1>

</div>


<p class="text-muted">
Guidance and tips for using the programming language R
</p>
<hr />
<div id="what-is-it" class="section level2">
<h2>What is it</h2>
<hr />
<p>R is an open-source programming language specifically aimed at
statisticians and data analysts.</p>
<hr />
</div>
<div id="what-is-it-for" class="section level2">
<h2>What is it for</h2>
<hr />
<p>R can be used for almost anything you can think of, notably data
analysis, data visualisation, and creating reports and dashboards. It
can also be used to extract data from SQL databases and run SQL
queries.</p>
<hr />
</div>
<div id="how-to-get-it" class="section level2">
<h2>How to get it</h2>
<hr />
<p>Download R (language) and RStudio (IDE) from the DfE software center.
We also recommend that you download RTools (a helpful R extension) at
the same time.</p>
<p>There are usually a couple of different versions available for
software on the software center, we’d recommend you always go for the
latest (newest) version possible.</p>
<!-- gif getting this from the software center -->
<hr />
</div>
<div id="best-places-to-start" class="section level2">
<h2>Best places to start</h2>
<hr />
<ul>
<li><p>The DfE Analytics Academy host an <a
href="https://trello.com/invite/b/QdDx3VmA/96f273b3438db2bb8ee5feae3943c3d4/analytics-academy-an-r-training-course"
target="_blank" rel="noopener noreferrer">online R training course</a>.
This is a great resource full of reproducible examples using DfE data.
The course takes you through initially getting R downloaded, all the way
through to developing apps in RShiny.</p></li>
<li><p>There is also the <a
href="https://dfe-analytical-services.github.io/r-training-course/"
target="_blank" rel="noopener noreferrer">DfE R training guide</a>,
which is a great starting point and reference to guide you through how
to get started using R and RStudio.</p></li>
<li><p>As an alternative, with a number of options for beginners to R,
<a href="https://education.rstudio.com/learn/beginner/" target="_blank"
rel="noopener noreferrer">RStudio Education</a> provide a variety of
materials to suit different learning styles.</p></li>
</ul>
<hr />
</div>
<div id="best-practice" class="section level2">
<h2>Best practice</h2>
<hr />
<p>Tips for reaching best practice in R can be found on our <a
href="rap.html#Clean_final_code">RAP page</a>, with guidance on meeting
best practice in RAP for clean final code. This makes it easier to read
and pick up if another person is running your code.</p>
<hr />
</div>
<div id="how-to-work-with-r" class="section level2">
<h2>How to work with R</h2>
<hr />
<div id="r-projects" class="section level3">
<h3>R Projects</h3>
<hr />
<p>Whenever you are using R, you should work in an RProject. This just
makes sure you are set up in the correct working directory, so your code
is pointing at the right folders and files.</p>
<p><a
href="https://support.rstudio.com/hc/en-us/articles/200526207-Using-Projects"
target="_blank" rel="noopener noreferrer">This guide for using projects
in R</a> is a really useful article to help you set up a project.</p>
<p>You can check which project you are working in by looking in the top
right hand corner of RStudio:</p>
<p><img src="images/Rproj.png" /><!-- --></p>
<hr />
</div>
<div id="outlines" class="section level3">
<h3>Outlines</h3>
<hr />
<p>In RStudio you can greatly increase the navigability of your code by
taking advantage of outlines. <a
href="https://support.rstudio.com/hc/en-us/articles/200484568-Code-Folding-and-Sections"
target="_blank" rel="noopener noreferrer">More information on folding
and navigating outlines in RStudio</a> can be found online, though when
using rmarkdown reports, remember to use names first, such as
<code>## Rows that aren't matching: r nrow(joined %&gt;% filter(matching == FALSE))</code>,
rather than having the R code first, so that they are easy to discern in
the outline.</p>
<hr />
</div>
<div id="renv" class="section level3">
<h3>renv</h3>
<hr />
<p>You should use the <a
href="https://rstudio.github.io/renv/articles/renv.html" target="_blank"
rel="noopener noreferrer">renv package</a> for package and version
control in R.</p>
<p>Packages and versions of R regularly update. Over time, this can
cause code to break - e.g. if different dependencies are required for
later versions of packages to work. Using renv creates a “snapshot” of
your code and packages at the time you created it, which anyone can then
recreate when they come to use your code.</p>
<p>This is really important for reproducibility, and will help you meet
elements of great practice with <a
href="rap.html#recyclable-code-for-future-use">recyclable code for
future use</a>.</p>
<hr />
<div id="renvrestore" class="section level4">
<h4>renv::restore()</h4>
<hr />
<p>Sometimes renv::restore() can fail, and when in specific
renv-controlled projects install.packages() will fail saying that
packages aren’t available even when they clearly are. There are a couple
of workarounds we have found that get around this failure.</p>
<ol style="list-style-type: decimal">
<li>Configuring the proxy settings by running the below in R - this also
helps if you are getting timeout issues when trying to webscrape with
R:</li>
</ol>
<pre><code>Sys.setenv(no_proxy=&quot;*&quot;) 
</code></pre>
<ol start="2" style="list-style-type: decimal">
<li>Specifying the renv library as the install location. It’s a bit of a
fudge, though these lines are helpful to get the packages from the renv
lockfile installed and you running the project when needed:</li>
</ol>
<pre><code>myPath &lt;- .libPaths()[1]

forceInstall &lt;- function(pkg, path) {
missing &lt;- suppressWarnings(eval(parse(text= paste0(&quot;!require(&quot;,pkg,&quot;)&quot;))))

if(missing == FALSE){
message(pkg, &quot; is already installed.&quot;)
} else{
install.packages(pkg, lib = path)
}
}

forceInstall(&quot;jsonlite&quot;, myPath)

renvPackages &lt;- names(jsonlite::fromJSON(&quot;renv.lock&quot;, flatten = TRUE)$Packages)

invisible(lapply(renvPackages, forceInstall, path = myPath))</code></pre>
<p>More manual equivalent to use for specific packages:</p>
<pre><code>.libPaths() # note down output 1, and reuse in the lib argument of install.packages() as below

install.packages(&quot;rmarkdown&quot;, lib = &quot;C:/Users/swong/OneDrive - Department for Education/Documents/stats-production-guidance/renv/library/R-4.0/x86_64-w64-mingw32&quot;)
</code></pre>
<hr />
</div>
<div id="updating-packages-in-renv" class="section level4">
<h4>Updating packages in renv</h4>
<hr />
<p>To update a single package run:</p>
<p><code>renv::update("dplyr")</code></p>
<p>To update all packages run:</p>
<p><code>renv::update()</code></p>
<hr />
</div>
<div id="installing-old-package-versions-in-renv"
class="section level4">
<h4>Installing old package versions in renv</h4>
<hr />
<p>This is surprisingly neat to do. Let’s say you wanted to roll back to
version 1.0.2 of dplyr, you would run the following:</p>
<p><code>renv::install("dplyr@1.0.2")</code></p>
<hr />
</div>
</div>
</div>
<div id="quick-reference-lookup" class="section level2">
<h2>Quick reference lookup</h2>
<hr />
<ul>
<li>If you want a useful guide for R syntax or functions, then look no
further than the <a href="https://rstudio.com/resources/cheatsheets/"
target="_blank" rel="noopener noreferrer">R cheat sheets</a>, these can
be an invaluable point of reference. Below we’ve included a few
particularly relevant ones:
<ul>
<li>Introduction to the <a
href="https://github.com/rstudio/cheatsheets/raw/master/rstudio-ide.pdf"
target="_blank" rel="noopener noreferrer">RStudio environment</a></li>
<li><a
href="http://github.com/rstudio/cheatsheets/raw/master/base-r.pdf"
target="_blank" rel="noopener noreferrer">Base R</a></li>
<li><a
href="https://github.com/rstudio/cheatsheets/raw/master/data-import.pdf"
target="_blank" rel="noopener noreferrer">Importing data into R</a></li>
<li><a
href="https://github.com/rstudio/cheatsheets/raw/master/data-transformation.pdf"
target="_blank" rel="noopener noreferrer">dplyr</a> for data
manipulation</li>
<li><a
href="https://github.com/rstudio/cheatsheets/raw/master/strings.pdf"
target="_blank" rel="noopener noreferrer">stringr</a> for string
manipulation</li>
<li><a
href="https://github.com/rstudio/cheatsheets/raw/master/regex.pdf"
target="_blank" rel="noopener noreferrer">Regex</a></li>
<li><a
href="https://rstudio.com/wp-content/uploads/2015/02/rmarkdown-cheatsheet.pdf"
target="_blank" rel="noopener noreferrer">RMarkdown</a></li>
<li><a
href="https://github.com/rstudio/cheatsheets/raw/master/shiny.pdf"
target="_blank" rel="noopener noreferrer">RShiny</a></li>
<li><a
href="https://rstudio.com/wp-content/uploads/2015/03/ggplot2-cheatsheet.pdf"
target="_blank" rel="noopener noreferrer">ggplot2</a> for data
visualisations</li>
<li><a
href="https://github.com/rstudio/cheatsheets/raw/master/purrr.pdf"
target="_blank" rel="noopener noreferrer">purrr</a> for applying
functions</li>
</ul></li>
</ul>
<hr />
</div>
<div id="other-resources" class="section level2">
<h2>Other resources</h2>
<hr />
<ul>
<li><p>Here is another free introduction to R course by <a
href="https://www.quantargo.com/courses/course-r-introduction/"
target="_blank" rel="noopener noreferrer">Quantargo</a>.</p></li>
<li><p><a href="https://bookdown.org/yihui/rmarkdown/" target="_blank"
rel="noopener noreferrer">R Markdown: The Definitive Guide</a>,
hopefully this one should be relatively self-explanatory!</p></li>
<li><p><a href="https://datascienceineducation.com/" target="_blank"
rel="noopener noreferrer">Data science in education</a> provides a
heavily detailed guide for beginners in R learning to process data, with
some well written out sections that may be of interest.</p></li>
<li><p>Handy guide to <a
href="https://support.rstudio.com/hc/en-us/articles/200484568-Code-Folding-and-Sections"
target="_blank" rel="noopener noreferrer">collapsing and sectioning R
code</a> for easy navigation in RStudio.</p></li>
<li><p>Here are <a
href="https://towardsdatascience.com/five-tidyverse-tricks-you-may-not-know-about-c5026d5a19da"
target="_blank" rel="noopener noreferrer">5 handy tidyverse
functions</a> that you should know if you’re using R to process data.
Number two is especially useful for those processing wide data into a
tidy format!</p></li>
<li><p>MoJ have produced <a
href="https://github.com/moj-analytical-services/writing_functions_in_r"
target="_blank" rel="noopener noreferrer">guidance on writing functions
in R</a></p></li>
<li><p>If you’re wondering how best to make the jump to R from Excel and
SQL, take a look at this <a
href="https://educationgovuk.sharepoint.com/sites/sarpi/g/WorkplaceDocuments/Forms/AllItems.aspx?FolderCTID=0x012000C61C1076C17C5547A6D6D8C2A27B5D97&amp;View=%7B2B35083D%2D7626%2D48E2%2D9615%2D451544742692%7D&amp;id=%2Fsites%2Fsarpi%2Fg%2FWorkplaceDocuments%2FInducation%20learning%20and%20career%20development%2FCoffee%20and%20Coding%2F181121%5FDavd%5FExceltoR%2FSQL%5FEXCEL%5Fto%5FR%5FHow%5Fto%5FMake%5Fthe%5FJump%2Ehtml&amp;parent=%2Fsites%2Fsarpi%2Fg%2FWorkplaceDocuments%2FInducation%20learning%20and%20career%20development%2FCoffee%20and%20Coding%2F181121%5FDavd%5FExceltoR"
target="_blank" rel="noopener noreferrer">coffee and coding
presention</a> by David Sands.</p></li>
<li><p>Malcolm Barrett has done some slides on <a
href="https://malco.io/slides/hs_dplyr/#1" target="_blank"
rel="noopener noreferrer">dplyr</a>, <a
href="https://malco.io/slides/hs_ggplot2/#1" target="_blank"
rel="noopener noreferrer">ggplot2</a>, and using <a
href="https://lar-purrr.netlify.app/#1" target="_blank"
rel="noopener noreferrer">purrr</a> which may be useful if you’re
looking at learning more about any of those packages.</p></li>
<li><p>Also check out the <a
href="https://garthtarr.github.io/meatR/janitor.html" target="_blank"
rel="noopener noreferrer">janitor</a> package, it has some particularly
powerful functions that are worth a look for tidying and QA’ing
data.</p></li>
</ul>
<hr />
</div>
<div id="excel-functions-in-r" class="section level2">
<h2>Excel functions in R</h2>
<hr />
<p>R can do everything you do in excel, but takes out the human error.
The reference table below shows how you would carry out popular Excel
commands in R.</p>
<p>R comes in with a built-in dataset called “iris”. We’ll use this for
all examples so you can recreate them in your local area.</p>
<p><strong>REMEMBER:</strong> R is case sensitive, so all references to
column names/entries need to be as-is in the dataset you are looking at.
<a
href="https://www.rdocumentation.org/packages/janitor/versions/1.2.0/topics/clean_names">Functions
exist</a> that can translate all your columns to lower or snake case for
ease!</p>
<table>
<colgroup>
<col width="18%" />
<col width="63%" />
<col width="18%" />
</colgroup>
<thead>
<tr class="header">
<th><strong>Common Excel Task</strong></th>
<th><strong>Example with iris </strong></th>
<th><strong>How to do in R with dplyr</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Select specific columns</strong></td>
<td>Select only species and petal length</td>
<td><code>iris %&gt;% select(Species, Petal.Length)</code></td>
</tr>
<tr class="even">
<td><strong>List unique entries in field (column)</strong></td>
<td>Find the unique entries for the “Species” column in iris</td>
<td><code>iris %&gt;% select(Species) %&gt;% distinct()</code></td>
</tr>
<tr class="odd">
<td><strong>Filter/select based on criteria</strong></td>
<td>Filter for sepal length &gt;4 and sepal width &lt;2.5, but NOT
“versicolor” species</td>
<td><code>iris %&gt;% filter(Sepal.Length &gt; 4 &amp;</code> <br />
<code>Sepal.Width &lt;2.5 &amp; Species != "versicolor")</code></td>
</tr>
<tr class="even">
<td><strong>Filter for multiple criteria in same column</strong></td>
<td>Filter for all “setosa” and “versicolor” species</td>
<td><code>iris %&gt;% filter(Species %in% c("setosa", "versicolor")</code></td>
</tr>
<tr class="odd">
<td><strong>If else with OR</strong></td>
<td>Create new column called “size_group” based on length or width of
petal</td>
<td><code>iris %&gt;% mutate(size_group =</code><br /><code>if_else( Petal.Length &gt; 4 | Petal.Width &gt;1.5, "Large", "Small"))</code></td>
</tr>
<tr class="even">
<td><strong>Multiple if else</strong></td>
<td>Create new column called “flower_price” based on species and petal
length</td>
<td><code>iris %&gt;%  mutate(flower_price = case_when(</code> <br />
<code>Species == "setosa" &amp; Petal.Length &gt; 1.5 ~"top band",</code><br /><code>Species == "versicolor" &amp; Petal.Length &lt; 4 ~"low_band",</code><br />
<code>TRUE ~ "mid_band"))</code></td>
</tr>
<tr class="odd">
<td><strong>COUNTIF</strong></td>
<td>Count the number of species if they have a petal length &gt;1.5</td>
<td><code>iris %&gt;% filter(Petal.Length &gt; 1.5 ) %&gt;%</code><br /><code>group_by(Species) %&gt;% count()</code></td>
</tr>
<tr class="even">
<td><strong>SUMIF</strong></td>
<td>Sum petal width of species if sepal width &lt;3</td>
<td><code>iris %&gt;% filter(Sepal.Width &lt;3) %&gt;%</code><br /><code>group_by(Species) %&gt;%</code><br /><code>summarise(Petal.Width = sum(Petal.Width))</code></td>
</tr>
<tr class="odd">
<td><strong>VLOOKUP</strong></td>
<td>Lookup to a table called “lookup”</td>
<td><code>iris %&gt;%  left_join(lookup, by.x="Species", by.y ="plant_species")</code></td>
</tr>
<tr class="even">
<td><strong>Order by</strong></td>
<td>Order dataset by descending petal width</td>
<td><code>iris %&gt;% arrange(desc(Petal.Width))</code></td>
</tr>
</tbody>
</table>
<p>More tips for moving from using Excel to using R can be found in the
<a
href="https://github.com/dfe-analytical-services/excel-to-R/wiki/Excel-to-R---how-do-I...">excel-to-R
wiki</a>.</p>
<hr />
</div>
<div id="sql-functions-in-r" class="section level2">
<h2>SQL functions in R</h2>
<hr />
<p>R can do a lot of the things that are possible in SQL. The reference
table below shows how you would carry out some popular SQL commands in
R.</p>
<p><strong>REMEMBER:</strong> R is case sensitive, so all references to
column names/entries need to be as-is in the dataset you are looking at.
<a
href="https://www.rdocumentation.org/packages/janitor/versions/1.2.0/topics/clean_names">Functions
exist</a> that can translate all your columns to lower or snake case for
ease!</p>
<table>
<colgroup>
<col width="47%" />
<col width="52%" />
</colgroup>
<thead>
<tr class="header">
<th>Common SQL Task</th>
<th>How to do in R (with dplyr)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>SELECT * FROM TABLE</strong></td>
<td><code>table %&gt;% select()</code></td>
</tr>
<tr class="even">
<td><strong>SELECT ColA, ColB, ColC FROM TABLE</strong></td>
<td><code>table %&gt;% select(ColA, ColB, ColC)</code></td>
</tr>
<tr class="odd">
<td><strong>SELECT DISTINCT ColA FROM TABLE</strong></td>
<td><code>table %&gt;% select(ColA) %&gt;% distinct()</code></td>
</tr>
<tr class="even">
<td><strong>TABLE A LEFT JOIN (TABLE B) ON TABLEA.x =
TABLEB.y</strong></td>
<td><code>tableA %&gt;% left_join(TableB, by = c(x = y))</code></td>
</tr>
<tr class="odd">
<td><strong>CASE WHEN x = 1 THEN 1, WHEN x =2 THEN 2, ELSE 0 END AS
New_column_name</strong></td>
<td><code>%&gt;% mutate (New_column_name = case_when (x == 1 ~ 1, x == 2 ~ 2, TRUE ~ 0))</code></td>
</tr>
<tr class="even">
<td><strong>CONCAT(LEA, ESTAB) AS LAESTAB</strong></td>
<td><code>%&gt;% mutate(LAESTAB = paste0(LEA, ESTAB))</code></td>
</tr>
<tr class="odd">
<td><strong>SELECT COUNT(*) FROM TABLE</strong></td>
<td><code>table %&gt;% nrow()</code></td>
</tr>
<tr class="even">
<td><strong>SELECT COUNT(ColA) FROM TABLE</strong></td>
<td><code>table %&gt;% count(colA)</code></td>
</tr>
<tr class="odd">
<td><strong>SELECT Date_column = CONVERT(DATE, Date_column) FROM
TABLE</strong></td>
<td><code>table %&gt;% mutate(Date_column = as.Date(Date_column))</code></td>
</tr>
<tr class="even">
<td><strong>SELECT Number_column = CONVERT(INT, Number_column ) FROM
TABLE</strong></td>
<td><code>table %&gt;% mutate(Number_column = as.numeric(Number_column))</code></td>
</tr>
<tr class="odd">
<td><strong>SELECT String_column = CONVERT(VARCHAR, String_column ) FROM
TABLE</strong></td>
<td><code>table %&gt;% mutate(String_column = as.character(String_column))</code></td>
</tr>
<tr class="even">
<td><strong>DROP TableA</strong></td>
<td><code>rm(TableA)</code></td>
</tr>
</tbody>
</table>
<p>More tips for moving from using SQL to using R can be found in the <a
href="https://github.com/dfe-analytical-services/excel-to-R/wiki/SQL-to-R-how-do-I...">SQL-to-R
wiki</a>.</p>
<hr />
</div>
<div id="tips-for-using-r" class="section level2">
<h2>Tips for using R</h2>
<hr />
<p>A selection of handy bits of code and workarounds for common issues.
More useful code snippets can also be found in our <a
href="https://github.com/dfe-analytical-services/automated-data-qa"
target="_blank" rel="noopener noreferrer">github repo</a></p>
<hr />
<div id="specifying-a-version-of-r-to-use" class="section level3">
<h3>Specifying a version of R to use</h3>
<hr />
<p>This can be done most easily by navigating in RStudio through
<code>Tools &gt; Global options &gt; General &gt; Basic &gt; R version (change)</code>.
It’s likely you’ll need to restart RStudio for the changes to take
affect.</p>
<!-- We cover this in the excel to R section -->
<!-- ### Mutating columns -->
<!-- Where you have a simple if else scenario use `mutate(col = if_else(expression, TRUE, FALSE)`, rather than `mutate(col = case_when(expression ~ TRUE, TRUE ~FALSE)` it's both quicker and easier on the eye! -->
<hr />
<!-- This is going into DfER- remove once it's in? -->
</div>
<div id="rounding" class="section level3">
<h3>Rounding</h3>
<hr />
<p>The base R function of round() rounds 5’s downwards. To round them
upwards you can create a custom function like the one below:</p>
<pre><code>roundFiveUp &lt;- function(x, n){ 
    z = abs(x)*10^n 
    z = z + 0.5 + sqrt(.Machine$double.eps) 
    z = trunc(z) 
    z = z/10^n 
    positiveNegative = sign(x) 
    return(z * positiveNegative) 
}</code></pre>
<!-- covered in SQL to R section -->
<!-- ### Grouping sets in R -->
<!-- The data.table package has a really neat function that can produce quick pivots and subtotals as you would using grouping sets in SQL. More information can be found at [this R bloggers post](https://www.r-bloggers.com/2019/03/creating-blazing-fast-pivot-tables-from-r-with-data-table-now-with-subtotals-using-grouping-sets/){target="_blank" rel="noopener noreferrer"}, with handy written examples to walk you through.  -->
<hr />
</div>
<div id="passing-variables-as-arguments" class="section level3">
<h3>Passing variables as arguments</h3>
<hr />
<p>This can be worked around by using a combination of
<code>eval()</code> and <code>parse()</code>, as shown in the below
function:</p>
<pre><code>showFilterLevels &lt;- function(data, meta) {
  filters &lt;- meta %&gt;%
    filter(col_type == &quot;Filter&quot;) %&gt;%
    pull(col_name)

  levelsTable &lt;- function(filter) {
    return(eval(parse(text = paste0(&quot;data %&gt;% select(&quot;, filter, &quot;) %&gt;% distinct()&quot;))))
  }

  output &lt;- lapply(filters, levelsTable)

  return(output)
}</code></pre>
<hr />
</div>
<div id="reverse-additive-filters" class="section level3">
<h3>Reverse additive filters</h3>
<hr />
<p>You might want to filter your dataset based on multiple negative
conditions. Normally to filter on multiple conditions, you would use
<code>filter(condition1 &amp; condition2)</code>. The “filter” function
does not work well with negative conditions (i.e. filtering for cases
where condition 1 and condition 2 are not met). Instead, you can use
<code>subset(!(condition1 &amp; condition2)</code>.</p>
<hr />
</div>
<div id="file-locations" class="section level3">
<h3>File locations</h3>
<hr />
<p>Struggling to get files to talk to one another, or get code to find
and use another R script? Use <code>here::here()</code> and marvel at
it’s wondrous ability to magic away issues.</p>
<hr />
</div>
<div id="interweaving-vectors" class="section level3">
<h3>Interweaving vectors</h3>
<hr />
<p>There’s an easy way to interweave multiple vectors into one single
vector using <code>c(rbind())</code>. The example below shows two
vectors, but you can have even more if you need.</p>
<pre><code>#Two vectors, x and y
x &lt;- 1:3
y &lt;- 4:6

#Run code to interweave
c(rbind(x, y))

#Output below
# [1] 1 4 2 5 3 6</code></pre>
<hr />
</div>
<div id="making-charts-interactive" class="section level3">
<h3>Making charts interactive</h3>
<hr />
<p>When pulling ggplot charts into RMarkdown reports, you can consider
making them even more user-friendly and interactive with plotly. <a
href="https://plotly.com/ggplot2" target="_blank"
rel="noopener noreferrer">Further information on how to make your charts
interactive with plotly</a> can be found online.</p>
<pre><code>#Simple ggplot chart called &quot;p&quot;
p &lt;- ggplot(dat, aes(x=xvar, y=yvar)) +
    geom_point(shape=1)      # Use hollow circles

#Apply ggplotly() to it to make it interactive
fig &lt;- ggplotly(p)
</code></pre>
<hr />
</div>
<div id="replace-all-values-with-another" class="section level3">
<h3>Replace all values with another</h3>
<hr />
<p>Have you ever needed to replace every value in your data with
another? This can come in handy when you are looking at suppression,
e.g. converting all NAs to “z” or all values under a certain threshold
to “c”.</p>
<pre><code>data %&gt;% mutate_all(~ replace(., . == &quot;Value to replace&quot;, &quot;Replacement&quot;))
</code></pre>
<hr />
</div>
<div id="temporary-groups" class="section level3">
<h3>Temporary groups</h3>
<hr />
<p>The group_by() function in dplyr is really useful, but can be fiddly
if you only want to use it for one operation in a chunk of code. The
with_groups() function from <a
href="https://dplyr.tidyverse.org/reference/with_groups.html"
target="_blank" rel="noopener noreferrer">dplyr</a> lets you do this,
saving you having to group and ungroup data each time.</p>
<pre><code>data %&gt;% mutate(annual_average = with_groups(time_period, mean))
</code></pre>
<hr />
</div>
<div id="finding-package-dependencies" class="section level3">
<h3>Finding package dependencies</h3>
<hr />
<p>Often we’ll take chunks of code and reuse them for new projects. This
can lead to building up a long list of packages to install, not all of
which end up being used in your new code. The <strong>NCmisc</strong>
package is a really handy way to check which packages and functions are
used in your code.</p>
<p>Firstly, load up all the packages the code has <code>library()</code>
commands for, then run the following:</p>
<pre><code>list.functions.in.file(&#39;your-filename-here.R&#39;, alphabetic = TRUE)</code></pre>
<hr />
</div>
<div id="visualise-dependencies" class="section level3">
<h3>Visualise dependencies</h3>
<hr />
<p>The <a href="https://github.com/crsh/depgraph" target="_blank"
rel="noopener noreferrer">depgraph package</a> allows you to plot a
graph of all the dependencies in your R project, which can be a useful
tool to help you cut down on the number of package dependencies.
Briefly, in these graphs you can look for “hot spots” in the network
(big bright dots), which represent packages that have many upstream
dependencies but are potentially easy to remove because they have few
downstream dependencies (that is, only your package depends on
them).</p>
<pre><code>plot_dependency_graph(
  pkg = multibridge_pkg
  , suggests = FALSE
  , option = &quot;cividis&quot;
)
</code></pre>
<hr />
</div>
<div id="reproducible-random-numbers" class="section level3">
<h3>Reproducible random numbers</h3>
<hr />
<p>The <a
href="https://www.rdocumentation.org/packages/simEd/versions/2.0.0/topics/set.seed"
target="_blank" rel="noopener noreferrer">set.seed()</a> function
generates a sequence of random numbers, starting from the value you
define in the brackets. This ensures you get the same sequence of random
numbers each time you run set.seed() with the same value, which is
helpful to test that your results are reproducible.</p>
<pre><code># random sampling
&gt; sample(LETTERS, 5)
[1] &quot;K&quot; &quot;N&quot; &quot;R&quot; &quot;Z&quot; &quot;G&quot;
&gt; sample(LETTERS, 5)
[1] &quot;L&quot; &quot;P&quot; &quot;J&quot; &quot;E&quot; &quot;D&quot;

# reproducible random sampling
&gt; set.seed(42); sample(LETTERS, 5)
[1] &quot;Q&quot; &quot;E&quot; &quot;A&quot; &quot;J&quot; &quot;D&quot;
&gt; set.seed(42); sample(LETTERS, 5)
[1] &quot;Q&quot; &quot;E&quot; &quot;A&quot; &quot;J&quot; &quot;D&quot;
</code></pre>
<hr />
</div>
<div id="automatic-logging" class="section level3">
<h3>Automatic logging</h3>
<hr />
<p>The <a
href="https://cran.r-project.org/web/packages/tidylog/readme/README.html"
target="_blank" rel="noopener noreferrer">tidylog package</a> is a
really useful tool for providing automated feedback on dplyr and tidyr
operations.</p>
<pre><code>library(tidylog)

filtered &lt;- filter(mtcars, cyl == 4)
#&gt; filter: removed 21 rows (66%), 11 rows remaining
mutated &lt;- mutate(mtcars, new_var = wt ** 2)
#&gt; mutate: new variable &#39;new_var&#39; (double) with 29 unique values and 0% NA</code></pre>
<hr />
</div>
<div id="running-sql-scripts-from-r" class="section level3">
<h3>Running SQL scripts from R</h3>
<hr />
<p>R can be used to execute SQL scripts to extract data from a database
as well as querying the database directly via R. For using R to execute
a SQL script you’ll need the SQL script/s to be in your R Project and to
make a connection via R to the database.</p>
<pre><code># Library calls ====

library(odbc)
library(DBI)

# DB connection ====

con &lt;- DBI::dbConnect(odbc::odbc(),
                      Driver = &quot;ODBC Driver 17 for SQL Server&quot;,
                      Server = &quot;server_name&quot;,
                      Database = &quot;database_name&quot;,
                      UID = &quot;&quot;,
                      PWD = &quot;&quot;,
                      Trusted_Connection = &quot;Yes&quot;
)

# Function to read in sql scripts ====

getSQL &lt;- function(filepath){
  con = file(filepath, &quot;r&quot;)
  sql.string &lt;- &quot;&quot;
  
  while (TRUE){
    line &lt;- readLines(con, n = 1)
    
    if ( length(line) == 0 ){
      break
    }
    
    line &lt;- gsub(&quot;\\t&quot;, &quot; &quot;, line)
    
    if(grepl(&quot;--&quot;,line) == TRUE){
      line &lt;- paste(sub(&quot;--&quot;,&quot;/*&quot;,line),&quot;*/&quot;)
    }
    
    sql.string &lt;- paste(sql.string, line)
  }
  
  close(con)
  return(sql.string)
}

# Execute SQL query and pull into R ====

my_table &lt;- dbGetQuery(con, getSQL(&quot;my_query_script.sql&quot;))
</code></pre>
<p>If you’re struggling to get your SQL scripts to execute from R, try
adding the following two lines to the top of your SQL script to force
the formatting required for it to work:</p>
<pre><code>SET ANSI_PADDING OFF
SET NOCOUNT ON;</code></pre>
<hr />
</div>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
